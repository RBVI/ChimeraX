PREREQ_MAKE = 1
TOP	= ../..
include $(TOP)/mk/config.make
include ../pips/Makefile.pip

# pypi is missing binary version for macOS and Windows.
# PEP517 does not allow install from source wheels and
# setuptools-45.1.0 enforces PEP517 by default.
# Version 3.0.2 is built using cmake, and that is
# a bridge too far.  Sticking with 2.1.2.

VERSION = 2.1.2
DISTRIBUTION = line_profiler-$(VERSION).tar.gz
SOURCE = $(tmpdir)/line_profiler-$(VERSION)
PIPINSTALL_ARGS = --upgrade-strategy only-if-needed

ifdef WIN32
WHEEL = `cygpath -m $(SOURCE)/dist/*.whl`
else
WHEEL = $(SOURCE)/dist/*.whl
endif

all:

install: $(SOURCE)
	cd $(SOURCE) && $(PYTHON_EXE) setup.py $(SETUP_ARGS) bdist_wheel
	$(PYTHON_EXE) -m pip install $(PIPINSTALL_ARGS) $(WHEEL)

app-install: install
	cd $(SOURCE) && $(APP_PYTHON_EXE) setup.py $(SETUP_ARGS) bdist_wheel
	$(APP_PYTHON_EXE) -m pip install $(PIPINSTALL_ARGS) $(WHEEL)

$(SOURCE): $(DISTRIBUTION)
	tar zxf $(DISTRIBUTION) -C $(tmpdir)
	# force _line_profiler.c to be regenerated by Cython
	rm -f $(SOURCE)/_line_profiler.c

$(DISTRIBUTION):
	$(FETCH_PREREQ) $(PREREQS_ARCHIVE)/lineprofiler/$(DISTRIBUTION)

upload_new_version:
	$(RSYNC) $(DISTRIBUTION) $(PREREQS_UPLOAD)/lineprofiler

clean:
	rm -rf $(SOURCE)
