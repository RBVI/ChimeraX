<html>
  <!--
=== UCSF ChimeraX Copyright ===
Copyright 2024 Regents of the University of California.
All rights reserved.  This software provided pursuant to a
license agreement containing restrictions on its disclosure,
duplication and use.  For details see:
http://www.rbvi.ucsf.edu/chimerax/docs/licensing.html
This notice must be embedded in or attached to all copies,
including partial copies, of the software or any revisions
or derivations thereof.
=== UCSF ChimeraX Copyright ===
-->

  <head>
    <link rel="stylesheet" type="text/css" href="../userdocs.css" />
    <title>ChimeraX Tutorial: Viewing Metadata of and Segmenting DICOM Images</title>
  </head>
  <body>
    <a name="top"></a>
    <a href="../index.html">
      <img
        width="60px"
        src="../ChimeraX-docs-icon.svg"
        alt="ChimeraX docs icon"
        class="clRight"
        title="User Guide Index"
    /></a>

    <h3>
      <a
        href="https://www.rbvi.ucsf.edu/chimerax/tutorials.html"
        target="_blank"
        >ChimeraX Tutorial</a
      >: Viewing Metadata of and Segmenting DICOM Images
    </h3>

    <blockquote>
      <b>
        <a href="#data">Sample Data</a>
        <br /><a href="#metadata">Viewing Metadata</a> 
        <br /><a href="#segtool">Using the Segmentations Tool</a>
      </b>
    </blockquote>

    <p>
      This tutorial covers basics of using ChimeraX, both on the desktop and in
      <a href="../vr.html">virtual reality</a> to interactively segment
      <a href="../dicom/dicom.html">DICOM medical imaging data</a>. The part of
      the tutorial pertaining to VR assumes you have the necessary equipment for
      virtual reality already installed and set up for the room.
      Descriptions below are for Oculus hand controllers, but other systems have hand-controller
      buttons that are generally similar in position and function.
    </p>
    <p>
      See also:
      <a href="../dicom-quickref.html">ChimeraX DICOM Reference</a>,
      <a
        href="https://www.rbvi.ucsf.edu/chimerax/dicom/index.html"
        target="_blank"
        >ChimeraX for Medical Image Analysis</a
      >
    </p>

    <a name="data"></a>
    <h3><a href="#top" class="nounder">&larr;</a> Sample Data</h3>
    <table class="clRight">
        <tr>
          <td>
            <a href="./download_dicom.png">
              <img
                class="outline"
                src="./download_dicom.png"
                title="click to enlarge..."
                alt="screenshot 1"
                width="500px"
            /></a>
          </td>
        </tr>
      </table>
     <p>
 
     <table class="clRight">
        <tr>
          <td>
            <a href="./dd_studies.png">
              <img
                class="outline"
                src="./dd_studies.png"
                title="click to enlarge..."
                alt="screenshot 1"
                width="500px"
            /></a>
          </td>
        </tr>
      </table>
 
     <table class="clRight">
        <tr>
          <td>
            <a href="./dd_series.png">
              <img
                class="outline"
                src="./dd_series.png"
                title="click to enlarge..."
                alt="screenshot 1"
                width="500px"
            /></a>
          </td>
        </tr>
      </table>


    <p>
      <a href="../startup.html">Start ChimeraX</a> by clicking its icon. After
      the ChimeraX window appears, open any DICOM data.
    </p>
    <p>
    You may use any local CT, PET, MRI, or X-Ray data, including the same sample data used in the <a href="./dicom-vr.html">DICOM in Virtual Reality</a> tutorial. To open local data:
    </p>
   
    <blockquote>
      Menu: <b>File &rarr; Open DICOM Folder</b> (dialog shows Format: DICOM image),
      browse to location, select directory, click <b>Choose</b>
    </blockquote>
   
     ChimeraX
    also includes a tool called <a href="../tools/downloaddicom.html">Download DICOM</a> that can be used to retrieve data
    from the Cancer Imaging Archive.
    Data from the
    Cancer Imaging Archive have been 
      <a
        href="https://wiki.cancerimagingarchive.net/display/Public/De-identification+Knowledge+Base"
        target="_blank"
        >anonymized</a
      >
      and are
      <a
        href="https://wiki.cancerimagingarchive.net/display/Public/Data+Usage+Policies+and+Restrictions"
        target="_blank"
        >freely available</a
      >. 
      To open this tool:
    </p> 
 
    <div>
      <blockquote>
      Menu: <b>Tools &rarr; Medical Imaging &rarr; Download DICOM</b><br/>
      Command: <a href="cxcmd: ui tool show 'Download DICOM'">ui tool show 'Download DICOM'</a>
  
      </blockquote>

   </div>
    <p>
    A one-time disclaimer will prompt you to accept TCIA's terms of use. If you accept their terms, the tool will start gathering information about TCIA datasets for you.
    When it is finished downloading, the data will be cached so that the tool starts up faster next time, and the tool's dataset table will be updated to show all available
    datasets.
    </p>
    <p>
    Over 120 datasets are available from TCIA, each having different modalities, but for the purposes of this tutorial the RIDER Lung CT dataset is best. If you choose another
    dataset and encounter problems, please file a bug report or email <a href="mailto:chimerax-users@cgl.ucsf.edu">chimerax-users</a>. When you click on a dataset, the 'Load Webpage'
    button will become active. Clicking on it will open a web browser window in ChimeraX, letting you see information about the database and its usage policy. The webpage will also
    tell you any limitations on the use of the data, and how to cite it should you write a paper based off of the data.
    </p>
    <p>
    Click any dataset and then click "Drill Down to Studies". The tool will take a moment and download information about each study in the dataset. When finished, the table will
    update to show all studies. From here, you can either go back to the list of all datasets, or refine further to series for individual patients.
    </p>
    <p>
    Click any study and then click "Drill Down to Series". The tool will take a moment and download information about each series in the study. When finished, the table will
    update to show all series. Finally, you can click an individual series and downloading by clicking the "Download and Open" button. This is a 'blocking' operation, meaning
    ChimeraX will freeze as the data is being downloaded and open it for you when it is finished.
    </p>
    <p>
    Alternatively, if you know the exact series you want to download, you can also use its TCIA Series Instance UID to download it using the 'open' command:
    <blockquote>
      Command: <a href="cxcmd: open 1.3.6.1.4.1.9328.50.1.298748100008818908989408006815250397386 fromDatabase tcia format dicom">open 1.3.6.1.4.1.9328.50.1.298748100008818908989408006815250397386 fromDatabase tcia format dicom</a>
    </blockquote>
    </p>
    <p>
    When you've opened some data you can close the tool.
    <blockquote>
      Command: <a href="cxcmd: ui tool hide 'Download DICOM'">ui tool hide 'Download DICOM'</a>
    </blockquote>
    </p>

    <a name="metadata"></a>
    <div style="min-height: 500px;">
    <h3><a href="#top" class="nounder">&larr;</a>Viewing Metadata</h3>
  
    <table class="clRight">
      <tr>
        <td>
          <a href="./dicom_browser.png">
            <img
              class="outline"
              src="./dicom_browser.png"
              title="click to enlarge..."
              alt="screenshot 1"
              width="500px"
          /></a>
        </td>
        <td>
          <a href="./dicom_metadata.png">
            <img
              class="outline"
              src="./dicom_metadata.png"
              title="click to enlarge..."
              alt="screenshot 1"
              height="450px"
          /></a>
        </td>
      </tr>
    </table>


    <p>
      ChimeraX now has tools to show DICOM metadata that can be opened either from the menu, model menu 'Info' button, or a command.
     <blockquote>
      Menu: <b>Tools &rarr; Medical Imaging &rarr; DICOM Browser</b><br/>
      Model Menu: <b>Click on Data &rarr; Click 'Info'</b><br/>
      Command: <a href="cxcmd: ui tool show 'DICOM Browser'">ui tool show 'DICOM Browser'</a>
      </blockquote>
    </p>
    <p>
    If the tools are accessed from the model menu, then clicking 'Info' while a Patient or Study is highlighted will bring up the DICOM browser. If a series
    is highlighted then the 'DICOM Metadata' tool will open to show more detailed information on a per-file basis.
    </p>
    <p>
    When you open new DICOM data, ChimeraX attempts to find out whether the patient and study containing that data are already open. If they are, ChimeraX merges 
    the incoming data with the open patient under the same model, puts any series that is part of an open study under that same study, and any images that are a
    part of an open series under the same series.
      </p>
    <p>
    The DICOM Browser is aware of new data and these merging operations, and updates itself to show new entries automatically. Clicking on a
      patient will narrow the studies shown to just that patient's studies, and clicking on a study will narrow the series shown to just series in that study.
    </p>
    <p>
      To open the 'DICOM Metadata' tool, open the DICOM browser and click a series or range of series, then click the 'Show Metadata' button on the DICOM Browser tool.
      A new window will open showing the value of each DICOM tag. Double clicking on a tag will open a web browser that will show you the definition of the tag in the 
      DICOM specification. Using the tool's scroll bar, you can see the metadata for all files in the series.
      When you're satisfied that everything seems to be in order, you can close both tools.
     <blockquote>
      Command: <a href="cxcmd: ui tool hide 'DICOM Metadata'">ui tool hide 'DICOM Metadata'</a><br/>
      Command: <a href="cxcmd: ui tool hide 'DICOM Browser'">ui tool hide 'DICOM Browser'</a>
      </blockquote>
 
    </p>
    </div>


    <a name="segtool"></a>
    <div style="min-height: 1300px">
    <h3><a href="#top" class="nounder">&larr;</a>Using the Segmentations Tool</h3>
    <table class="clRight">
      <tr>
        <td>
          <a href="./segmentations_first_opened.png">
            <img
              class="outline"
              src="./segmentations_first_opened.png"
              title="click to enlarge..."
              alt="screenshot 1"
              width="500px"
          /></a>
        </td>
      </tr>
      <tr>
        <td>
          <a href="./2d_segmentation.png">
            <img
              class="outline"
              src="./2d_segmentation.png"
              title="click to enlarge..."
              alt="screenshot 1"
              width="500px"
          /></a>
        </td>
      </tr>
       <tr>
        <td>
          <a href="./segmentation_settings.png">
            <img
              class="outline"
              src="./segmentation_settings.png"
              title="click to enlarge..."
              alt="screenshot 1"
              width="500px"
          /></a>
        </td>
      </tr>
    </table>

    <p>For a refresher on basic manipulations of medical data, you can reference 
      <a href="./dicom-vr.html">previous DICOM tutorials.</a>
      before proceeding. Open the <b><a href="../tools/segmentations.html">Segmentations</a></b> tool by using the menu or by command:
    </p>
    <blockquote>
      Menu: <b>Tools &rarr; Volume Data &rarr; Segmentations</b><br/>
      Command: <a href="cxcmd: ui tool show segmentations">ui tool show segmentations</a>
    </blockquote>
    <p>
      By default, the tool will rearrange the user interface to show three two-dimensional slices, one for each 
      of the axial, coronal, and sagittal axes, with the axial in the upper left, the coronal in the lower left,
      a 3D view in the upper right, and the sagittal in the lower right. The data in the 3D view will automatically
      be changed to a surface. You can change the default view from the Segmentation tool's settings menu. 
      You may also change the view layout when any volume data is open and without opening the tool by using the ui command:
    </p>

    <blockquote>
      Command: <a href="cxcmd: ui view fourup">ui view fourup</a> &mdash; As described above <br/>
      Command: <a href="cxcmd: ui view overunder">ui view overunder</a> &mdash; 3D above, axial, coronal, sagittal below (left to right)<br/>
      Command: <a href="cxcmd: ui view sidebyside">ui view sidebyside</a>&mdash; 3D left, axial, coronal, sagittal right (top to bottom)<br/>
    </blockquote>

    <p>
    You may add the "guidelines true" option to any of the above commands to turn on crosshairs which show, for any slice, the location of the 
    other two slices. There is a checkbox on the Semgentation tool that will also enable or disable them.
    </p>

    <p>You can also use the tool's settings menu to change the default view upon opening.</p> 
    <p>
      When using one of the modes that shows 2D slices, those slices will be added to the <a href="../tools/volumeviewer.html"><b>Volume Viewer</b></a> 
      panel so they can be windowed and leveled independently of the 3D model, which may optionally be set back to the volume rendering mode. The 2D 
      views also report which axis they are displaying in an overlay, and provide a slider that allows you to change the slice you're viewing. You
      can also move using the arrow keys, or by ten slices using SHIFT+arrow, when the 2D view is in focus.
    </p> 
    <p>
      When the segmentation tool is opened and you mouse over the 2D slices, a cursor will be displayed showing the location that would be segmented
      if you clicked on the slice. If no segmentation has been created, one will be created for you upon clicking for the first time. When you stop
      moving your mouse, a tooltip will pop up showing the intensity in Hounsfield units under the cursor.
    </p>

    <p>
      You can press the middle mouse button (a.k.a. the scroll wheel) and drag on any slice to pan it around. To zoom in and out on the slice, roll
      the scroll wheel or right click and drag. A left click begins tracking your mouse movement -- when you release the left mouse button, all regions
      you mark off for segmenting will be added to the current segmentation. You can change the size of the cursor with SHIFT+scroll, and you can erase
      from the segmentation by holding shift as you left click and drag. ChimeraX will display your segmentation in 3D and over the 2d slices.
    </p>

    <p>
      You can also create segmentations on the command line and edit them.
      <blockquote>
        Command: <a href="cxcmd: segmentations create 1.1.1">segmentations create 1.1.1</a><br/>
        Command: <a href="cxcmd: segmentations add 2 planeCenter 100,100 radius 10 slice 100 axis axial">segmentations add 2 planeCenter 100,100 radius 10 slice 100 axis axial</a> &mdash; (to create a segmentation on one slice)<br/>
        Command: <a href="cxcmd: segmentations add 2 sphereCenter 100,100,100 radius 10">segmentations add 2 sphereCenter 100,100,100 radius 10</a> &mdash; (to create a 3D segmentation)
      </blockquote>
    </p>

    <p>
      You can press the middle mouse button (a.k.a. the scroll wheel) and drag on any slice to pan it around. To zoom in and out on the slice, roll
      the scroll wheel or right click and drag. A left click begins tracking your mouse movement -- when you release the left mouse button, all regions
      you mark off for segmenting will be added to the current segmentation. You can change the size of the cursor with SHIFT+scroll, and you can erase
      from the segmentation by holding shift as you left click and drag. ChimeraX will display your segmentation in 3D and over the 2d slices.
    </p>

    <p>
        If you find that segmentations are obstructing your view of your data, you can use the Volume Viewer to adjust their opacity. 
        own drawings, segmentations use the same data for all four views. Adjusting the opacity of the segmentation will adjust it for all windows in the view.
        You can also add an arbitrary number of segmentations. Choosing a different segmentation in the tool's list of segmentations will change which one is
        shown in the 2D slice viewers. You can also use the segmentation tool's options menu to set a different default opacity from the factory setting of 80%.
    </p>

    <p>
      You can also make segmentations in 3D. Switch the layout back to 3D only:
      <blockquote>
        Segmentation Tool: <b>View layout dropdown &rarr; 3D only (desktop)</b><br/>
        Command: <a href="cxcmd: ui view default">ui view default</a>
      </blockquote>
    In this mode, a sphere is spawned in the center of the model to be segmented. To enable segmentation mouse modes, you can use the toolbar button or the 
    command it calls:
      <blockquote>
        Toolbar: <b>Medical Image &rarr; Segmentation Controls &rarr; Set Mouse Modes</b><br/>
        Command: <a href="cxcmd: segmentations setMouseModes">segmentations setMouseModes</a>
      </blockquote>
    You can also use the segmentation tool's settings menu to set mouse modes automatically. 
    </p>
    <p>
      In 3D, right clicking adds to the segmentation and SHIFT-right-clicking removes from the segmentation. To move the sphere without adding regions to
      or removing regions from the segmentation, hold the shift key and middle mouse button while moving the mouse. Like in the 2D views, SHIFT+scroll 
      resizes the sphere. For speed, whenever you are adding areas to or removing them from the segmentation, ChimeraX will render the segmentation at a
      slightly lower resolution. It will be shown in full resolution when you stop your operation.
    </p>
    <p>
      At any time, you can unset the mouse modes:
      <blockquote>
        Toolbar: <b>Medical Image &rarr; Segmentation Controls &rarr; Reset Mouse Modes</b><br/>
        Command: <a href="cxcmd: segmentations resetMouseModes">segmentations resetMouseModes</a>
      </blockquote>
    This will also happen automatically if you close the tool or close all models. Additionally, closing all models will close the tool and reset
      the view mode to the default, 3D only layout.
    </p> 
    <p>
        Lastly before moving on to VR, you can save your segmentation to disk in DICOM format. It will
        be associated with the patient and study it was derived from when it is next opened in ChimeraX.
    </p>
    </div>

    <a name="segtoolvr"></a>

    <div style="min-height: 700px">
    <h3><a href="#top" class="nounder">&larr;</a>Segmenting in VR</h3>
    <table border cellpadding="4" cellspacing="0" class="clRight">
      <tr>
        <td align="center" width="30%">
        Add to Segmentation <br /><img
            src="../tools/create_segmentation.png"
            class="icon3"
          />
        </td>
        <td class="text">
          &nbsp;Right Oculus <b><i>B</i></b> button
        </td>
        <td style="border-style: solid none solid solid" rowspan="5" align="center" valign="center" width="200px">
          <a href="vr_lefthand.png">
            <img
              class="outline"
              src="vr_lefthand.png"
              title="click to enlarge..."
              alt="right hand controller"
              width="120px"
              height="190px"
          /></a>
          <br /><br /><font size="-1">
            In this image of the left hand cone, the <b><i>X</i></b> button is bound to 'Hide Segmentations' as
              described in this table. The precise position of the buttons may be shown differently
              for Vive controllers.
          </font>
        </td>
        <td style="border-style: solid solid solid none" rowspan="5" align="center" valign="center" width="200px">
          <br /><br /><a href="vr_righthand.png">
            <img
              class="outline"
              src="vr_righthand.png"
              title="click to enlarge..."
              alt="left hand controller"
              width="120px"
              height="190px"
          /></a>
          <br /><br /><font size="-1">
            In this image of the right hand cone, the icons show that the 
              <b><i>grip</i></b> button is bound to 'Move Cursor', the
              <b><i>A</i></b> button is bound to 'Add to Segmentation', the
              <b><i>B</i></b> button is bound to 'Remove from Segmentation', and the
              <b><i>thumbstick</i></b> button is bound to 'Resize Cursor', as
              described in this table. The precise position of the buttons may be shown differently
              for Vive controllers.
          </font>
           </div>
        </td>
      </tr>
      <tr>
        <td align="center">
          Remove from Segmentation <br /><img
            src="../tools/create_segmentation.png"
            class="icon3"
          />
        </td>
        <td>
          &nbsp;Right Oculus <b><i>A</i></b> button
        </td>
      </tr>
      <tr>
        <td align="center">
          Resize Cursor <br /><img src="../tools/resize_cursor.png" class="icon3"/>
        </td>
        <td class="text">
          &nbsp;Right Oculus <b><i>thumbstick</i></b>
        </td>
      </tr>
      <tr>
        <td align="center">
          Move Cursor <br /><img
            src="../tools/move_cursor.png"
            class="icon2"
          />
        </td>
        <td class="text">
          &nbsp;Right Oculus <b><i>grip</i></b> button
        </td>
      </tr>
      <tr>
        <td align="center" class="text">
          Hide Segmentations
          <br /><br />
        </td>
        <td class="text">
          &nbsp;Left Oculus <b><i>X</i></b> button
        </td>
      </tr>
    </table>
    <p>
      To switch to VR segmenting, use the dropdown on the tool. If configured to do so, the tool will start VR
      and configure hand modes for you automatically. If you need to set hand modes manually or turn off segmentation
      hand modes, you can use the ChimeraX toolbar in VR to do so.
      <blockquote>
        Toolbar: <b>Medical Image &rarr; Segmentation Controls &rarr; Set Hand Modes</b> &mdash; (to turn on segmentation hand modes)<br/>
        Toolbar: <b>Medical Image &rarr; Segmentation Controls &rarr; Reset Hand Modes</b> &mdash; (to turn off segmentation hand modes)
      </blockquote>
    </p>
 
    <p>
      In VR, the right Oculus <b><i>grip</i></b> button is used to move the segmentation cursor without
      adding its path to or removing it from the segmentation. To add to the segmentation, hold down the
      <b><i>A</i></b> button and move the right hand controller. To remove from the segmentation, hold down
      the right <b><i>B</i></b> button and move the right hand controller. To make the segmentation cursor
      larger or smaller, push up or pull down on the right <b><i>thumbstick</i></b>. 
    </p>
    <p>
      The left Oculus controller's 
      <b><i>X</i></b> button can be used to temporarily hide the segmentation when held. While the <b><i>X</i></b>
      button is held, the cursor can still be resized and the segmentation can still be expanded or erased; the 
      <b><i>X</i></b> button is used for visibility; segmentations can begin to occlude fine details when they grow
      large.
    </p>
    <p>
      These controls are summarized in the table on the right. Other buttons are unchanged from their defaults
      or user settings. The <b><i>left trigger</i></b>, <b><i>left grip</i></b>, or <b><i>right trigger</i></b> 
      still move the reference data, and the <b><i>Y</i></b> button summons the ChimeraX UI, which can be used to
      change hand modes, adjust volume rendering, change segmentations, and add or remove them.
    </p>
  </div>

    <hr />
    <address>
      UCSF Resource for Biocomputing, Visualization, and Informatics / May 2024
    </address>
  </body>
</html>
